---
title: "Working with Property Price Indices"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with Property Price Indices}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

Brazil has several Residential Property Price Indices (RPPI) from different sources, each with unique methodologies and coverage. This vignette shows how to access and analyze these indices using the realestatebr package.

```{r setup, message=FALSE}
library(realestatebr)
library(dplyr)
library(ggplot2)

# Helper function for consistent plot styling
theme_series <- function() {
  theme_minimal() +
    theme(
      legend.position = "bottom",
      palette.colour.discrete = c("#27708CFF", "#85A693FF", "#A6511FFF", "#BFA575FF", "#B4D9CEFF")
    )
}

```

## Available RPPI Datasets

### Individual Indices

Access specific RPPI by name:

```{r}
# FipeZap Index (most comprehensive - 20 cities)
fipezap <- get_dataset("rppi", "fipezap")

# IVGR - National sales index from BCB
ivgr <- get_dataset("rppi", "ivgr")

# IGMI - Hedonic sales index from FGV
igmi <- get_dataset("rppi", "igmi")

# IVAR - Rent index from FGV
ivar <- get_dataset("rppi", "ivar")

# IQA - QuintoAndar rent prices
iqa <- get_dataset("rppi", "iqa")

# Secovi-SP - São Paulo market index
secovi_sp <- get_dataset("rppi", "secovi_sp")
```

### Stacked Indices

For easy comparison across sources:

```{r}
# All sale indices in one table
sale_indices <- get_dataset("rppi", "sale")
unique(sale_indices$source)
# Shows: IGMI-R, IVG-R, FipeZap, Secovi-SP

# All rent indices
rent_indices <- get_dataset("rppi", "rent")
unique(rent_indices$source)
# Shows: IVAR, IQA, Secovi-SP, FipeZap
```

## Understanding the Data Structure

### Common Columns

Most RPPI datasets share these columns:

- **date**: reference date (usually month-end)
- **index**: index number (base varies by source)
- **chg**: monthly percent change
- **acum12m**: 12-month accumulated change
- **name_muni**: city or region name

### Specific Cases

### QuintoAndar (IQA)

Unlike other indices, IQA provides actual rent prices instead of an index. Creating an based index from these prices is straightforward. The code below shows how to create a base 100 index for each municipality, using the first available rent price as the base (i.e. 2019/06 = 100).

```{r}
library(dplyr)

iqa <- get_dataset("rppi", "iqa")

iqa <- iqa |>
  mutate(
    index = rent_price / first(rent_price) * 100,
    .by = name_muni
  )
```

It's important to note that IQA went through a significant change in methodology in mid-2022, which may affect trend analysis.

### FipeZap

FipeZap is the most detailed RPPI, it includes both residential and non-residential markets, rent and sale indices, and breakdowns by number of bedrooms. The level of granularity, however, is not available for all cities.


- **market**: residential or commercial
- **rent_sale**: sale or rent market
- **rooms**: breakdown by number of bedrooms (1, 2, 3, 4+, total)
- **variable**: index, chg, acum12m, price_m2 (median listing price), yield (rental yield).


## Example: Comparing National Sale Indices

```{r}
# Get stacked sale data
sales <- get_dataset("rppi", "sale")

# Filter for national indices
national <- sales |>
  filter(name_muni %in% c("Brazil", "Brasil"))

# Plot comparison
ggplot(national, aes(x = date, y = index, color = source)) +
  geom_line(linewidth = 1) +
  labs(title = "Brazil National RPPI - Sales",
       subtitle = "Different methodologies, same trend",
       x = NULL,
       y = "Index (base varies by source)",
       color = "Source") +
  theme_series()
```

## Example: FipeZap by City

```{r}
# Get FipeZap data
fz <- get_dataset("rppi", "fipezap")

# Filter for major cities - residential sale index
cities <- fz |>
  filter(
    market == "residential",
    rooms == "total",
    variable == "index",
    rent_sale == "sale",
    name_muni %in% c("São Paulo", "Rio De Janeiro", "Belo Horizonte")
  )

# Plot
ggplot(cities, aes(x = date, y = value, color = name_muni)) +
  geom_line(linewidth = 0.8) +
  labs(title = "FipeZap Sale Index - Major Cities",
       x = NULL,
       y = "Index",
       color = "City") +
  theme_series()
```

## Rent vs Sale - São Paulo

```{r}
# Filter for São Paulo - both rent and sale
cities <- fz |>
  filter(
    name_muni %in% c("São Paulo", "Rio De Janeiro", "Belo Horizonte"),
    market == "residential",
    rooms == "total",
    variable == "index",
    date >= as.Date("2019-01-01")
  ) |>
  select(date, name_muni, rent_sale, value)

base_index <- cities |>
  filter(between(date, as.Date("2019-01-01"), as.Date("2019-12-31"))) |>
  summarise(
    base_index = mean(value),
    .by = c("name_muni", "rent_sale")
  )

cities <- cities |>
  left_join(base_index, by = c("name_muni", "rent_sale")) |>
  mutate(new_index = 100 * value / base_index) |>
  select(-base_index)

# Plot comparison
ggplot(cities, aes(x = date, y = new_index, color = rent_sale)) +
  geom_line() +
  geom_hline(yintercept = 100) +
  facet_wrap(vars(name_muni)) +
  labs(
    title = "Post-pandemic Rent vs Sale Divide",
    subtitle = "FipeZap residential index",
    x = NULL,
    y = "Index (100 = 2019 average)",
    color = "Market"
  ) +
  theme_series()
```

## Example: Regional Comparison with IGMI

```{r}
# Get IGMI data
igmi <- get_dataset("rppi", "igmi")

# Major cities comparison
cities_igmi <- igmi |>
  filter(name_muni %in% c("São Paulo", "Rio De Janeiro",
                          "Belo Horizonte", "Brasília"))

# Plot with facets
ggplot(cities_igmi, aes(x = date, y = index, color = name_muni)) +
  geom_line(linewidth = 0.8) +
  labs(title = "IGMI Sale Index by City",
       x = NULL,
       y = "Index") +
  theme_series()
```


## International Comparison

The package includes international RPPI data from the Bank for International Settlements (BIS):

```{r}
# Get BIS international RPPI
bis <- get_dataset("rppi_bis")

# Filter for select countries
countries <- bis |>
  filter(
    reference_area %in% c("Brazil", "United States", "Japan", "Germany"),
    is_nominal == FALSE,
    unit == "Index, 2010 = 100",
    date >= as.Date("2000-01-01")
  )

# Plot comparison
ggplot(countries, aes(x = date, y = value, color = reference_area)) +
  geom_line(linewidth = 0.8) +
  geom_hline(yintercept = 100) +
  labs(title = "Residential Property Prices - International",
       subtitle = "Nominal indices, 2010 = 100",
       x = NULL,
       y = "Index (2010 = 100)",
       color = "Country") +
  theme_series()
```

## Key Differences Between Indices

### Coverage

- **FipeZap**: 20 cities, most comprehensive geographic coverage
- **IVGR**: National
- **IGMI**: Major cities with hedonic adjustment
- **IVAR**: Major cities
- **IQA**: 2 cities (São Paulo, Rio de Janeiro)

### Methodology

- **IVGR**: Median prices from actual transactions.
- **IGMI**: Hedonic pricing model (controls for property characteristics).
- **IVAR**: Repeat-sales methodology.
- **FipeZap**: Median prices from listings.
- **IQA** (old): Median prices form rental contract prices.
- **IQA** (new): Hedonic pricing model from both listting and contract prices.

### Frequency

All indices are monthly, but historical coverage varies:
- IVGR: 2001-present
- IGMI: 2014-present
- FipeZap: 2008-present
- IVAR: 2002-present
- IQA: 2019-present
- Secovi-SP: 2008-present

## Analysis Tips

### 1. Use Stacked Data for Easy Comparisons

Stacked data makes it easier to compare multiple indices:

```{r}
# Get all sale indices in one table
all_sale <- get_dataset("rppi", table = "sale")

# Compare across sources
all_sale |>
  filter(name_muni == "São Paulo") |>
  ggplot(aes(x = date, y = acum12m, color = source)) +
  geom_line() +
  labs(title = "São Paulo Sale Indices Comparison")
```

### 2. Normalize Indices When Comparing Levels

Since each index has a different base period, normalize them for direct comparison:

```{r}
sales <- get_dataset("rppi", table = "sale")

sales_normalized <- sales |>
  mutate(index_normalized = 100 * index / first(index), .by = source)
```

### 3. Compare Growth Rates, Not Levels

Growth rates are more meaningful than absolute index levels:

```{r}
# 12-month growth comparison
sales |>
  ggplot(aes(x = date, y = acum12m, color = source)) +
  geom_line() +
  labs(y = "12-month change (%)")
```

## Next Steps

- See `vignette("getting-started")` for package basics
- See `?get_dataset` for all available tables
- Explore city-level data with FipeZap
- Compare methodologies across indices
- Analyze rent vs sale dynamics
