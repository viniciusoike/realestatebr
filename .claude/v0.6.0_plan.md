# v0.6.0 Development Plan - Codebase Simplification

**Status**: Phase 1 Complete ✅ (Phase 1A, 1B, 1C)
**Target**: Major code reduction and simplification
**Branch**: `main` (direct commits, pre-1.0.0)

## Overview

Version 0.6.0 focuses on dramatic codebase simplification through removal of deprecated code, streamlining documentation, and consolidating repetitive logic. This aligns with the goals outlined in CLAUDE.md.

**Current State**:
- Package size: ~10,000 lines across 25 R files
- 135 documentation files
- 115 internal functions with extensive documentation
- Significant code duplication in download/import logic

**Target State**:
- 30-40% code reduction (→ 6-7k lines)
- 50% reduction in internal function documentation
- 80% less code duplication
- All files under 500 lines (except get_cbic.R <1,000)

---

## ⚠️ IMPORTANT: Manual Review Required

### R/get_cbic.R (2,078 lines)

**This file requires manual review and cleanup BEFORE starting automated simplification work.**

- Current state: Very large (2,078 lines), complex structure
- Contains: Helper functions, import functions, cleaning functions, get functions
- Issues identified:
  - Repetitive table-specific cleaning logic
  - Multiple deprecated/unused code sections (commented out)
  - Incomplete implementation (steel/PIM marked for v0.4.1 but not done)
  - Complex multi-material structure that could be simplified

**Action Required**:
1. User must manually review and clean up get_cbic.R first
2. Remove old/deprecated code
3. Complete or remove steel/PIM placeholders
4. Only then can we apply generic simplification patterns

---

## Phase 1: Documentation Cleanup ✅ COMPLETED

**Goal**: Simplify internal function documentation while keeping essential information

**Status**: Completed 2025-10-08
**Total Lines Removed**: ~400 lines across 3 sub-phases

### Phase 1A: Initial Setup ✅
- ✅ Committed NAMESPACE changes (29 man/ files)
- ✅ Added .DS_Store to .gitignore
- ✅ Created v0.6.0_plan.md (395 lines)

### Phase 1B: Internal Helper Functions ✅
**Target**: Remove examples from truly internal helpers (Tier 2-3 functions)

**Completed**:
- ✅ R/utils.R - Removed 3 examples (is_debug_mode, cli_debug, cli_user)
- ✅ R/cache.R - Removed 1 example (import_cached)
- **Lines saved**: 45 lines

**Key Finding**: Only 10% of @examples blocks were removable (4 out of 38). Most examples belong to exported user-facing deprecated functions.

### Phase 1C: Deprecated Function Documentation ✅
**Target**: Remove examples and simplify docs for all deprecated functions

**Completed**: 8 functions simplified
- ✅ get_secovi()
- ✅ get_bcb_realestate()
- ✅ get_abrainc_indicators()
- ✅ get_abecip_indicators()
- ✅ get_rppi_bis()
- ✅ get_bcb_series()
- ✅ get_fgv_ibre()
- ✅ get_nre_ire()

**Changes per function**:
- Removed @examples blocks (8-13 lines each)
- Removed @section Progress Reporting and @section Error Handling
- Simplified @details to 1-3 essential lines
- Enhanced @section Deprecation with code migration examples
- Added @keywords internal, @export tags

**Impact**:
- **Lines removed**: 355 lines (632 deleted, 277 added)
- **Documentation focus**: Migration guidance instead of usage examples
- **Backward compatibility**: All functions remain exported and callable
- **NEWS.md updated**: Added v0.6.0 breaking changes section

**Files Modified**: 22 total
- 8 R/ source files
- 12 man/ documentation files
- 1 NAMESPACE
- 1 NEWS.md

**Commits**:
- Phase 1A: Setup (NAMESPACE, .gitignore)
- Phase 1B: bde8694 (utils.R), 031199e (cache.R)
- Phase 1C: dd0750d (8 deprecated functions)

### Phase 1: Success Metrics ✅
- ✅ Reduced documentation ~400 lines total
- ✅ Maintained all @param and @return documentation
- ✅ Enhanced migration guidance in deprecation sections
- ✅ All changes documented in NEWS.md

---

## Phase 2: Remove Deprecated Functions

**Goal**: Remove functions that only show deprecation warnings

### Audit Targets

1. **R/cache.R** (358 lines)
   - `import_cached()` - wrapped with deprecation warning
   - Check if entire file can be removed after sufficient migration period
   - Current status: Has been deprecated since v0.5.0

2. **Other Deprecated Functions**
   - Search pattern: `lifecycle::deprecate_*` or `.Deprecated`
   - Currently found in: cache.R only
   - Verify no other deprecation-only functions exist

3. **Decision Points**
   - Has it been >2 minor versions since deprecation?
   - Are there any remaining internal uses?
   - Update NEWS.md with breaking changes

---

## Phase 3: Consolidate Repetitive Logic

**Goal**: Extract common patterns into reusable generic helpers

### 1. Download/Import Logic Consolidation

**Current State**: Repeated patterns across:
- get_abecip_indicators.R (579 lines)
- get_abrainc_indicators.R (580 lines)
- get_bcb_series.R (351 lines)
- get_bcb_realestate.R (435 lines)
- get_property_records.R (679 lines)
- get_rppi.R (771 lines)
- get_secovi.R (438 lines)

**Common Patterns to Extract**:

```r
# Generic download-parse-validate-transform pipeline
process_dataset <- function(
  url,
  parser_fn,
  validator_fn = NULL,
  transformer_fn = NULL,
  retry_config = list(max_retries = 3L, backoff = TRUE)
) {
  # Shared retry logic with exponential backoff
  # Shared error handling
  # Shared progress reporting
  # Shared metadata attachment
}

# Generic table parameter validation
validate_table_param <- function(
  table,
  valid_tables,
  default_table = valid_tables[1],
  allow_all = TRUE
) {
  # Unified table validation logic
  # Consistent error messages
  # Support for "all" option
}

# Generic cache handling
handle_cache <- function(
  dataset_name,
  table,
  cached,
  fresh_data_fn,
  quiet = FALSE
) {
  # Unified cache lookup logic
  # Consistent fallback behavior
  # Shared cache writing
}
```

### 2. Fix "Legacy" Terminology

**Problem**: Confusing use of "legacy" after v0.4.0 architecture change

**Changes**:
- Rename `get_from_legacy_function()` → `get_from_internal_function()`
- Update all documentation referencing "legacy functions"
- Clarify that post-v0.4.0, all get_*() are internal, not legacy
- Update CLAUDE.md to reflect this terminology

**Files to update**:
- R/get-dataset.R
- R/utils.R (if helper exists there)
- Documentation in man/

### 3. Metadata Cleanup

**Audit Attributes**:
- `download_time` - Keep (useful for cache validation)
- `download_info` - Keep if contains useful diagnostics
- `source` - Keep (tracks data provenance)
- Custom metadata - Remove unless clearly useful

**Decision Criteria**:
- Is it used by other package functions?
- Is it displayed to users?
- Does it aid debugging?
- If no to all → Remove

---

## Phase 4: Code Reduction Targets

### Priority Files

1. **get_cbic.R** (2,078 → <1,000 lines)
   - ⚠️ MANUAL REVIEW REQUIRED FIRST
   - Extract cement/steel/PIM helpers to separate files
   - Consolidate table-specific cleaning functions
   - Remove commented-out code blocks (lines 882-983)
   - Apply generic download/process patterns

2. **get-dataset.R** (832 → <500 lines)
   - Refactor massive switch statement
   - Extract table resolution to helper
   - Remove repetitive validation code
   - Consolidate error messages

3. **get_rppi.R** (771 → <400 lines)
   - Already reduced 67% in v0.4.0
   - Further consolidation with rppi-helpers.R
   - Extract common RPPI processing patterns

4. **get_property_records.R** (679 → <400 lines)
   - Already reduced 14% in v0.5.0
   - Remove any remaining deprecated functions
   - Consolidate web scraping logic

5. **get_abecip_indicators.R / get_abrainc_indicators.R** (579/580 → <300 lines each)
   - Very similar structure (nearly identical line counts)
   - High potential for shared abstractions
   - Extract common indicator processing

---

## Testing & Quality Assurance

### Pre-Development
- ✅ Run comprehensive test suite
- ✅ Verify all datasets work with cache/fresh
- ✅ Run targets pipeline end-to-end
- ✅ Document baseline metrics

### During Development
- Add tests for new generic helpers
- Ensure no functionality regression
- Test cache behavior remains consistent
- Validate all table parameters still work

### Pre-Release
- Full devtools::check()
- Comprehensive integration tests
- Manual smoke tests for all datasets
- Update all documentation

---

## Breaking Changes Documentation

### NEWS.md Sections

```markdown
# realestatebr 0.6.0

## BREAKING CHANGES

### Deprecated Function Removal
- **Removed**: `import_cached()` - Use `load_from_user_cache()` or `get_dataset(source="cache")` instead
- **Removed**: [Other deprecated functions if any]

### Internal API Changes
- **Renamed**: Internal helper `get_from_legacy_function()` → `get_from_internal_function()`
  - This only affects package developers, not users
- **Removed**: Unused metadata attributes from some datasets

## Improvements

### Code Quality
- **Reduced codebase by 30-40%** (10k → 6-7k lines)
- **Simplified documentation** for internal functions
- **Consolidated repetitive logic** into generic helpers
- **All files now <500 lines** for better maintainability

### Developer Experience
- New generic helpers for dataset processing
- Consistent error messages across all functions
- Clearer code organization and structure

## No User-Facing Changes
- `get_dataset()` API remains unchanged
- All datasets continue to work exactly as before
- No changes to data formats or output structures
```

---

## Success Metrics

### Quantitative Goals
- [ ] Total lines: 10,000 → 6,000-7,000 (30-40% reduction)
- [ ] Files >500 lines: 4 → 1 (only get_cbic.R <1,000)
- [ ] Internal function docs: Average 50 lines → 15 lines
- [ ] Example blocks removed: ~50-75 blocks
- [ ] Code duplication: Reduce by 80%

### Qualitative Goals
- [ ] All files easy to understand and navigate
- [ ] Clear separation of concerns
- [ ] Generic helpers widely reused
- [ ] Consistent code patterns throughout
- [ ] No functionality regression

---

## Implementation Checklist

### Phase 1: Documentation (Low Risk, ~1 week)
- [ ] Audit all internal function documentation
- [ ] Remove examples from internal functions
- [ ] Simplify verbose @details sections
- [ ] Consolidate cache documentation
- [ ] Update cross-references

### Phase 2: Deprecations (Medium Risk, ~3 days)
- [ ] Verify deprecation timeline
- [ ] Remove cache.R if appropriate
- [ ] Update NEWS.md with breaking changes
- [ ] Test package still builds

### Phase 3: Generic Helpers (High Risk, ~2 weeks)
- [ ] Design generic helper interfaces
- [ ] Implement core helpers
- [ ] Write tests for new helpers
- [ ] Refactor 1-2 functions as proof of concept
- [ ] Apply helpers across all get_*() functions

### Phase 4: Code Reduction (High Risk, ~2 weeks)
- [ ] ⚠️ MANUAL: Review and clean get_cbic.R
- [ ] Refactor get-dataset.R switch statement
- [ ] Consolidate get_rppi.R with helpers
- [ ] Simplify property_records.R
- [ ] Extract shared logic from abecip/abrainc

### Phase 5: Testing & Release (Critical, ~1 week)
- [ ] Full test suite passes
- [ ] Integration tests pass
- [ ] Targets pipeline runs successfully
- [ ] Manual smoke tests completed
- [ ] Documentation built and reviewed
- [ ] NEWS.md finalized
- [ ] CLAUDE.md updated
- [ ] Create release PR
- [ ] Tag v0.6.0

---

## Risk Mitigation

### High-Risk Changes
1. **Generic helper refactoring**
   - Risk: Breaking existing functionality
   - Mitigation: Extensive tests before applying broadly
   - Rollback: Keep original functions until verified

2. **get_cbic.R simplification**
   - Risk: Complex structure, easy to break
   - Mitigation: Manual review first, careful testing
   - Rollback: Preserve original in separate branch

3. **Removing deprecated functions**
   - Risk: Users still depending on old API
   - Mitigation: Only remove after 2+ versions
   - Rollback: Can restore if critical issues found

### Low-Risk Changes
1. **Documentation cleanup**
   - Risk: Minimal (only affects developers)
   - Mitigation: Keep all essential information

2. **Terminology fixes**
   - Risk: Minimal (internal naming only)
   - Mitigation: Search-replace with verification

---

## Timeline Estimate

**Total: 6-8 weeks**

- Week 1-2: Planning, manual reviews, documentation cleanup
- Week 3-4: Generic helpers design and implementation
- Week 5-6: Apply helpers, code reduction
- Week 7: Testing and refinement
- Week 8: Documentation, release preparation

**Milestones**:
- End Week 2: Documentation simplified, deprecations removed
- End Week 4: Generic helpers tested and working
- End Week 6: All code reduction targets met
- End Week 8: Release-ready

---

## Notes

- This plan prioritizes simplification without changing user-facing APIs
- All changes maintain backward compatibility for `get_dataset()`
- Focus on reducing maintenance burden for future development
- Sets foundation for Phase 3 (DuckDB integration) in v0.7.0
