name: Daily Data Updates

# DISABLED: This workflow is currently disabled because the B3 stocks targets
# (b3_stocks_data, cache_daily_data) are not yet implemented in _targets.R.
# Re-enable this workflow once B3 data collection is added to the pipeline.

on:
  # schedule:
  #   # 6 AM Brazil time (UTC-3) = 9 AM UTC
  #   - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if data is recent'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-daily-data:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::targets
            any::tarchetypes
            any::cli
            any::here
            any::readr
            any::dplyr
            any::purrr
            any::remotes

      - name: Install package
        run: |
          Rscript -e 'remotes::install_local(".", dependencies = TRUE)'

      - name: Create required directories
        run: |
          mkdir -p data-raw/cache_output
          mkdir -p inst/reports
          mkdir -p _targets

      - name: Check current cache status
        run: |
          Rscript -e 'source("data-raw/pipeline/generate_report.R"); generate_quick_status()'

      - name: Run daily targets pipeline
        run: |
          Rscript -e '
            library(targets)

            # Run only daily targets (B3 stocks only)
            daily_targets <- c(
              "b3_stocks_data",
              "cache_daily_data"
            )

            cli::cli_h1("Running daily data pipeline")
            cli::cli_inform("Targets: {paste(daily_targets, collapse=\", \")}")

            tar_make(names = all_of(daily_targets))

            cli::cli_alert_success("Daily pipeline completed")
          '

      - name: Validate updated data
        run: |
          Rscript -e '
            source("data-raw/pipeline/validation.R")
            source("data-raw/pipeline/targets_helpers.R")

            # Validate cache integrity
            cache_valid <- validate_cache_integrity()

            if (!cache_valid) {
              cli::cli_alert_danger("Cache validation failed!")
              quit(status = 1)
            }

            cli::cli_alert_success("Cache validation passed")
          '

      - name: Generate status report
        run: |
          Rscript -e 'source("data-raw/pipeline/generate_report.R"); generate_pipeline_report()'

      - name: Create or update cache-latest release
        run: |
          # Check if release exists
          if gh release view cache-latest > /dev/null 2>&1; then
            echo "Release 'cache-latest' already exists"
          else
            echo "Creating release 'cache-latest'"
            gh release create cache-latest \
              --title "Latest Cached Data" \
              --notes "Automatically updated cached datasets. This release is continuously updated by the data pipeline." \
              --prerelease
          fi

      - name: Upload cached datasets to GitHub release
        run: |
          # Upload all files from cache_output to the release
          if [ -d "data-raw/cache_output" ] && [ "$(ls -A data-raw/cache_output)" ]; then
            echo "Uploading cached datasets to release 'cache-latest'"

            # Upload files, overwriting existing ones
            for file in data-raw/cache_output/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "Uploading $filename..."
                gh release upload cache-latest "$file" --clobber
              fi
            done

            echo "Upload completed successfully"
          else
            echo "No cached data files to upload"
          fi

      - name: Commit and push reports
        run: |
          # Only commit reports, not data files
          if [ -n "$(git status --porcelain inst/reports/)" ]; then
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"

            git add inst/reports/

            git commit -m "chore: update data pipeline reports (daily) - $(date +'%Y-%m-%d')"
            git push
          else
            echo "No report changes to commit"
          fi

      - name: Report completion status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Daily update completed successfully"
          else
            echo "❌ Daily update failed"
            exit 1
          fi